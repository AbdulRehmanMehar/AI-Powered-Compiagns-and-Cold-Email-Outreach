services:
  coldemails:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: coldemails
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - TZ=Asia/Karachi
      - PYTHONUNBUFFERED=1
      - DATABASE_URL=${DATABASE_URL}
      - OPENAI_API_KEY=${O_API_KEY}
      - ROCKETREACH_API_KEY=${ROCKETREACH_API_KEY}
      - ZOHO_EMAILS=${ZOHO_EMAILS}
      - ZOHO_PASSWORDS=${ZOHO_PASSWORDS}
      - ZOHO_SENDER_NAMES=${ZOHO_SENDER_NAMES}
      - EMAIL_ROTATION_STRATEGY=${EMAIL_ROTATION_STRATEGY}
      - EMAILS_PER_ACCOUNT=${EMAILS_PER_ACCOUNT}
      - VERIFY_EMAILS=${VERIFY_EMAILS}
      - VERIFY_SMTP=${VERIFY_SMTP}
      - LLM_PROVIDER=${LLM_PROVIDER}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - GROQ_MODEL=${GROQ_MODEL}
    healthcheck:
      test: ["CMD", "python", "-c", "from database import campaigns_collection; print('healthy') if campaigns_collection.database.client.server_info() else exit(1)"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    labels:
      - "com.docker.compose.project=coldemails"
      - "io.portainer.accesscontrol.teams=operations"
    logging:
      driver: gelf
      options:
        gelf-address: ${GELF_ADDRESS}
        tag: "{{.Name}}"
    networks:
      - app-network
      - elk

networks:
  app-network:
    driver: bridge
  elk:
    external: true
