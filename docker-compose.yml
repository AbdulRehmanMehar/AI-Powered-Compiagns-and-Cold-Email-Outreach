services:
  autonomouscoldemails:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: autonomouscoldemails
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - TZ=Asia/Karachi
      - PYTHONUNBUFFERED=1
      - DATABASE_URL=${DATABASE_URL}
      - OPENAI_API_KEY=${O_API_KEY}
      - ROCKETREACH_API_KEY=${ROCKETREACH_API_KEY}
      - ZOHO_EMAILS=${ZOHO_EMAILS}
      - ZOHO_PASSWORDS=${ZOHO_PASSWORDS}
      - ZOHO_SENDER_NAMES=${ZOHO_SENDER_NAMES}
      - EMAIL_ROTATION_STRATEGY=${EMAIL_ROTATION_STRATEGY}
      - EMAILS_PER_ACCOUNT=${EMAILS_PER_ACCOUNT}
      - VERIFY_EMAILS=${VERIFY_EMAILS}
      - VERIFY_SMTP=${VERIFY_SMTP}
      - LLM_PROVIDER=${LLM_PROVIDER}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - GROQ_MODEL=${GROQ_MODEL}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-qwen2.5:7b}
      - SCHEDULER_MODE=async
      - GLOBAL_DAILY_TARGET=${GLOBAL_DAILY_TARGET:-300}
      - EMAILS_PER_DAY_PER_MAILBOX=${EMAILS_PER_DAY_PER_MAILBOX:-50}
      - MIN_DELAY_BETWEEN_EMAILS=${MIN_DELAY_BETWEEN_EMAILS:-8}
      - MAX_DELAY_BETWEEN_EMAILS=${MAX_DELAY_BETWEEN_EMAILS:-14}
      - WARMUP_WEEK1_LIMIT=${WARMUP_WEEK1_LIMIT:-5}
      - WARMUP_WEEK2_LIMIT=${WARMUP_WEEK2_LIMIT:-12}
      - WARMUP_WEEK3_LIMIT=${WARMUP_WEEK3_LIMIT:-25}
      - WARMUP_WEEK4_LIMIT=${WARMUP_WEEK4_LIMIT:-45}
      - SENDING_HOUR_START=${SENDING_HOUR_START:-7}
      - SENDING_HOUR_END=${SENDING_HOUR_END:-19}
      - MAX_REPLENISH_PER_CYCLE=${MAX_REPLENISH_PER_CYCLE:-1}
      - WARMUP_EMAILS=${WARMUP_EMAILS:-mehars.6925@gmail.com,abdrehman6925@gmail.com,webdeveloper.6925@gmail.com}
      - WARMUP_EMAILS_APP_PASSWORDS=${WARMUP_EMAILS_APP_PASSWORDS:-}
      - PRIMARY_SENDER_MODE=${PRIMARY_SENDER_MODE:-zoho}
    healthcheck:
      test: ["CMD", "python", "-c", "from database import campaigns_collection; print('healthy') if campaigns_collection.database.client.server_info() else exit(1)"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    labels:
      - "com.docker.compose.project=autonomouscoldemails"
      - "io.portainer.accesscontrol.teams=operations"
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
